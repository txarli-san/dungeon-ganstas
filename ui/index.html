<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Text Adventure Game</title>
        <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
        <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
        <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
                padding: 0;
                background-color: #000;
            }
            #terminal {
                height: 100%;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div id="terminal"></div>
        <script>
            const term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Consolas, "Courier New", monospace',
                theme: {
                    background: "#000",
                    foreground: "#fff",
                },
            });
            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById("terminal"));
            fitAddon.fit();

            const socket = new WebSocket("ws://localhost:8080");
            let inputBuffer = "";

            socket.onmessage = (event) => {
                term.writeln(event.data);
                term.write("> ");
            };

            term.onKey(({ key, domEvent }) => {
                const printable =
                    !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;

                if (domEvent.keyCode === 13) {
                    // Enter key
                    term.writeln("");
                    socket.send(inputBuffer);
                    inputBuffer = "";
                } else if (domEvent.keyCode === 8) {
                    // Backspace
                    if (inputBuffer.length > 0) {
                        inputBuffer = inputBuffer.slice(0, -1);
                        term.write("\b \b");
                    }
                } else if (printable) {
                    inputBuffer += key;
                    term.write(key);
                }
            });

            window.addEventListener("resize", () => {
                fitAddon.fit();
            });

            socket.onopen = () => {
                term.writeln(
                    "Connected to the game server. Welcome to the Text Adventure!",
                );
                term.write("> ");
            };

            socket.onclose = () => {
                term.writeln("Disconnected from the game server.");
            };

            socket.onerror = (error) => {
                term.writeln(`WebSocket Error: ${error}`);
            };
        </script>
    </body>
</html>
